<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <style>

        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css");
        @import url('https://cdn.rawgit.com/moonspam/NanumSquare/master/nanumsquare.css');

        @font-face {
            font-family: 'NanumSquareRound';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/NanumSquareRound.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }


        #header {
            width: 800px;
            background: #f7f7f7;

        }

        .main {
            width: 800px;
        }

        .recommend {
            width: 800px;
            height: 80px;
            display: flex;
            align-items: center;
        }

        .recommendCount{
            font-size:20px;
            font-weight:bold;
            color:#696969;
            margin-left:20px;
            margin-right:20px;
        }

        .recommendButton {
            border-bottom-right-radius: 5px;
            border-top-right-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff
        }

        .report {
            width: 800px;
            height: 60px;
            background-color: #f7f7f7;
        }

        .article {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .body {
            margin-top: 70px;
            font-family: 'NanumSquare';
            transform: rotate(0.04deg);
        }

        .topbar {
            height: 40px;
        }

        .bottombar {
            height: 20px;
            display: flex;
        }

        .bar {
            padding: 20px;
        }

        #headline {
            color: #444444;
            font-weight: bold;
            font-size: 25px;
        }

        .bottomleft {
            display: flex;
            width: 380px;
        }

        .bottomright {

            text-align: right;
            width: 380px;
        }

        #name {
            color: #7c7c7c;
            margin-right: 10px;
            font-size: 15px;
        }

        #time {
            color: #7c7c7c;
            margin-right: 10px;
            font-size: 15px;
        }

        #category {
            color: #7c7c7c;
            font-size: 15px;
        }

        #view {
            color: #7c7c7c;
            font-size: 15px;
            margin-right: 10px;
        }

        #commentCount {
            color: #7c7c7c;
            font-size: 15px;
        }

        #line2 {
            color: #A5A5A5;
            width: 800px;
            margin: 50px 0px 0px;
        }

        #contents {
            margin: 20px;
        }

        #contents-text {
            font-size: 15px;
            margin-bottom: 10px;
        }

        #input {
            margin: 0px;
            border-bottom-left-radius: 1em;
            border-bottom-right-radius: 1em;
        }

        #coment-title {
            width: 800px;
            background-color: #7c7c7c;
            height: 40px;

        }

        #accordionExample {
            width: 800px;
        }

        .accordion-body {
            height: 150px;
            display: flex;
        }

        #coment-ok {
            width: 100px;
        }

        table {
            width: 800px;
        }

        .comment-recommend {
            width: 100px;
            display: flex;
            flex-direction: column;
            margin: 0px;
            padding: 0px;
            justify-content: center;
            align-items: center;
        }

        .up-down {
            width: 800px;
            display: flex;
            justify-content: center;
            align-items: center;

        }

        a {
            text-decoration: none !important;
        }

        /*댓글 추천 다운*/
        .bi-caret-down-fill {
            font-size: 17px;
        }

        /*댓글 추천 업*/
        .bi-caret-up-fill {
            font-size: 17px;
        }

        /*JS 시작*/

        /*테이블 tr*/
        .commentTr {
            border: 1px solid #e5e5e5;
            border-left: none;
            border-right: none;
            border-top: none;

        }

        /*테이블 추천 td*/
        .commentRecommendTd {
            padding-top: 10px;
            padding-bottom: 10px;
            text-align: center;
            width: 70px;
            padding: -30px;
        }


        /*테이블 내용(이름 날짜 내용..) td*/
        .commentContentTd {


        }

        /*위 테이블 내용 td안에 있는 div*/
        .commentContentDiv {
            margin-top: auto;
            margin-bottom: auto;
            vertical-align: middle;
        }

        .commentAuthor {
            font-weight: bold;
            font-size: 15px;
            margin-right: 10px;
        }

        .commentDate {
            font-size: 14px;
            color: #7f7f7f;
        }

        .commentContent {
            font-size: 15px;
        }

        /*댓글 수정, 삭제 버튼*/
        .commentButton {
            color: #7f7f7f;
            font-size: 14px;
            margin-right: 10px;
        }

        .commentTextarea{
            resize: none;
            width: 730px;
            height: 70px;
        }
    </style>
    <script th:inline="javascript">
        $(function () {
            printCommentList();
            printBoard();
            recommendCheck();
        });

        function printBoard() {
            $('#contents').html([[${boardResponseDto.content}]]);
        }

        function printCommentList() {
            let url = "/board/" + [[${boardResponseDto.id}]] + "/comment";
            $.get(url, function (response) {
                let table = document.getElementById('commentTable');
                $('.commentTr').remove();
                $.each(response, function (index, item) {
                    let commentTr = document.createElement('tr');
                    commentTr.setAttribute("class", "commentTr");

                    //comment Recommend
                    let commentRecommendTd = document.createElement('td');
                    commentRecommendTd.setAttribute("class", "commentRecommendTd");

                    let recommendUp = document.createElement('i');
                    let recommendDown = document.createElement('i');
                    let recommendCount = document.createElement('div');

                    recommendUp.setAttribute("class", "bi bi-caret-up-fill");
                    recommendDown.setAttribute("class", "bi bi-caret-down-fill");
                    recommendCount.setAttribute("class", "recommendCount");
                    recommendCount.innerText = '0';

                    commentRecommendTd.appendChild(recommendUp);
                    commentRecommendTd.appendChild(recommendCount);
                    commentRecommendTd.appendChild(recommendDown);

                    //comment Content
                    let commentContentTd = document.createElement('td');
                    commentContentTd.setAttribute("class", "commentContentTd");

                    let commentContentDiv = document.createElement('div');
                    commentContentDiv.setAttribute("class", "commentContentDiv");

                    let commentAuthor = document.createElement('span');
                    let commentDate = document.createElement('span');
                    let commentContent = document.createElement('div');
                    commentAuthor.setAttribute("class", "commentAuthor");
                    commentDate.setAttribute("class", "commentDate");
                    commentContent.setAttribute("class", "commentContent");
                    commentAuthor.innerText = item.author;
                    commentDate.innerText = item.createdDate;
                    commentContent.innerText = item.content;

                    commentContentDiv.appendChild(commentAuthor);
                    commentContentDiv.appendChild(commentDate);
                    commentContentDiv.appendChild(commentContent);

                    if (item.author == [[${userResponseDto.username}]]) {
                        let commentUpdate = document.createElement('span');
                        let commentDelete = document.createElement('span');
                        commentUpdate.setAttribute("class", "commentButton " + item.id);
                        commentDelete.setAttribute("class", "commentButton " + item.id);

                        commentUpdate.innerText = "수정";
                        commentDelete.innerText = "삭제";
                        commentContentDiv.appendChild(commentUpdate);
                        commentContentDiv.appendChild(commentDelete);
                        commentUpdate.addEventListener("click", function () {
                            updateComment(item.id, commentContent);
                        });
                        commentDelete.addEventListener("click", function () {
                            deleteComment(item.id);
                        })
                    }

                    commentContentTd.appendChild(commentContentDiv);

                    commentTr.appendChild(commentRecommendTd);
                    commentTr.appendChild(commentContentTd);
                    table.appendChild(commentTr);
                });

            })
        };

        function deleteBoard() {
            let check = confirm("정말로 삭제하시겠습니까?");
            if(check){
                $.ajax({
                    type: 'DELETE',
                    url: '/board/' + [[${boardResponseDto.id}]]
                }).done(function (response) {
                    window.location.replace('/boardlist');
                }).fail(function (e) {
                    console.log(e);
                });
            }
        }

        function recommendCheck(){
            $.ajax({
                type: 'POST',
                url: '/recommendcheck/' + [[${boardResponseDto.id}]]
            }).done(function (response) {
                if(response.recommend == 'yes'){
                    if(response.point == '1'){
                        let likeButton = document.getElementById('boardLikeButton');
                        likeButton.setAttribute("style", 'background-color: #FFB830; color:white; width:50px; border:none')
                    }else {
                        let hateButton = document.getElementById('boardHateButton');
                        hateButton.setAttribute("style", 'background-color: #6c757d; color:white; width:50px; border:none')
                    }
                }
            });
        }

        function commentCreate() {
            let commentContent = document.getElementById("commentCreate").value;
            $('#commentCreate').val('');
            let data = {
                chat: commentContent
            }

            $.ajax({
                type: 'POST',
                url: '/board/' + [[${boardResponseDto.id}]] + '/comment',
                data: JSON.stringify(data),
                contentType: "application/json;charset=UTF-8",
            }).done(function (response) {
                printCommentList();
                changeCommentCount();
            }).fail(function () {
                console.log("fail");
            });
        };

        function updateComment(id, commentContentDiv) {
            let updateTextarea = document.createElement('textarea');
            updateTextarea.value = commentContentDiv.innerText;
            updateTextarea.setAttribute('class', 'form-control commentTextarea');
            updateTextarea.setAttribute('style', 'border:1px solid #e5e5e5');

            let tempText = commentContentDiv.innerText;
            commentContentDiv.innerText = '';
            $('.'+id).remove();

            let commentUpdate = document.createElement('span');
            let commentCancel = document.createElement('span');
            commentUpdate.setAttribute("class", "commentButton " + id);
            commentCancel.setAttribute("class", "commentButton " + id);

            commentUpdate.innerText = "수정";
            commentCancel.innerText = "취소";
            commentUpdate.addEventListener("click", function () {
                let data = {
                    commentContent : updateTextarea.value
                }
                $.ajax({
                    type: 'PUT',
                    url: '/board/' + [[${boardResponseDto.id}]] + '/comment/' + id,
                    data: JSON.stringify(data),
                    contentType: "application/json;charset=UTF-8",
                }).done(function (response) {
                    printCommentList();
                });
            });
            commentCancel.addEventListener("click", function () {
                printCommentList();
            })

            commentContentDiv.appendChild(updateTextarea);
            commentContentDiv.appendChild(commentUpdate);
            commentContentDiv.appendChild(commentCancel);
        };

        function deleteComment(comment_id) {
            $.ajax({
                type: 'DELETE',
                url: '/board/' + [[${boardResponseDto.id}]] + '/comment/' + comment_id,
            }).done(function (response) {
                printCommentList();
                changeCommentCount();
            });
        };

        function changeCommentCount() {
            $.ajax({
                type: 'GET',
                url: '/board/' + [[${boardResponseDto.id}]] + '/comment'
            }).done(function (response) {
                document.getElementById('commentCountSpan').innerText = response.length;
            });
        }

        function like() {
            let recommendCountSpan = document.getElementById('recommendCount');

            $.ajax({
                type: 'POST',
                url: '/like/' + [[${boardResponseDto.id}]]
            }).done(function (response) {
                if(response.canRecommend == true){
                    recommendCountSpan.innerText = response.recommendCount;
                }else{
                    alert('추천을 수정할 수 없습니다.');
                }
                recommendCheck();
            });
        };

        function hate() {
            let recommendCountSpan = document.getElementById('recommendCount');

            $.ajax({
                type: 'POST',
                url: '/hate/' + [[${boardResponseDto.id}]]
            }).done(function (response) {
                if(response.canRecommend == true){
                    recommendCountSpan.innerText = response.recommendCount;
                }else{
                    alert('추천을 수정할 수 없습니다.');
                }
                recommendCheck();
            });
        };

    </script>
</head>

<div layout:fragment="content">

    <div class="article">
        <div class="body">
            <div id="header">
                <div class="bar">
                    <div class="topbar">
                        <span id="headline" th:text="${boardResponseDto.title}"></span>
                    </div>
                    <div class="bottombar">
                        <div class="bottomleft">
                            <span id="name" th:text="${boardResponseDto.author}"></span>
                            <span id="category" th:text="${boardResponseDto.createdDate}"></span>

                        </div>

                        <div class="bottomright">
                            <span id="view">조회&nbsp<span th:text="${boardResponseDto.view}"></span></span>
                            <span id="commentCount">댓글&nbsp
                                <span id="commentCountSpan" th:text="${boardResponseDto.commentCount}"></span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main">
                <div id="contents">

                </div>
            </div>
            <hr id="line2">

            <div class="recommend">
                <div class="up-down">

                    <button id="boardLikeButton" onclick="like()" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseExample"
                            style="width:50px;height:40px;display:flex;justify-content:center"
                            class="btn btn-outline-primary">
                        <i class="bi bi-caret-up-fill"></i>
                    </button>

                    <span id="recommendCount" class="recommendCount" th:text="${boardResponseDto.recommendCount}"></span>

                    <button id="boardHateButton" onclick="hate()" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseExample"
                            style="width:50px;height:40px;display:flex;justify-content:center"
                            class="btn btn-outline-secondary">
                        <i class="bi bi-caret-down-fill"></i>
                    </button>

                </div>
            </div>

            <div class="report">
                <div style="height:60px;display:flex;justify-content:right;align-items:center;margin-right:10px">
                    <a th:href="@{/board/update/{id}(id=${boardResponseDto.id})}"
                       style="font-size:15px; color: #7f7f7f">수정하기</a>
                    <button type="submit" onclick="deleteBoard()"
                            style="font-size:15px; color: #7f7f7f; margin-right:10px;border:none;background:transparent">
                        삭제하기
                    </button>
                </div>

            </div>

            <div class="comment" style="margin-top:20px">
                <div class="input-group" style="height:100px">
                    <textarea id="commentCreate" type="text" class="form-control"
                              placeholder="욕설, 비방, 과도한 표현은 제재의 대상이 될 수 있습니다."
                              aria-label="Recipient's username" aria-describedby="button-addon2"
                              style="border: 1px solid #ced4da;resize: none"></textarea>
                    <button class="btn btn-outline-primary" onclick="commentCreate()" type="button"
                            id="button-addon2">글쓰기
                    </button>
                </div>

                <div class="comment-view" style="margin-bottom:50px">
                    <table id="commentTable">

                    </table>
                </div>
            </div>

        </div>

    </div>
</div>
</html>